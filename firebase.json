rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default: deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // --- ARTIFACTS COLLECTION ---
    match /artifacts/{appId} {
      
      // --- PUBLIC PROFILES ---
      // Anyone can read public profiles by code
      match /public_profiles/{code} {
        allow read: if request.auth != null;
        // Only Cloud Functions can write
        allow write: if false;
      }

      // --- USER PROFILES & FRIENDS ---
      match /users/{userId} {
        // User can read/write own profile
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.uid == userId;

        // Friends subcollection
        match /friends/{friendId} {
          // User can read own friends
          allow read: if request.auth.uid == userId;
          // Only Cloud Functions can write
          allow write: if false;
        }

        // FCM Tokens
        match /fcm_tokens/{tokenId} {
          allow read: if request.auth.uid == userId;
          allow write: if request.auth.uid == userId;
        }

        // Secret Contacts (for Secret Chat)
        match /secret_contacts/{contactId} {
          allow read: if request.auth.uid == userId;
          allow write: if request.auth.uid == userId;
        }

        // Catch-all for user subcollections
        match /{document=**} {
          allow read: if request.auth.uid == userId;
          allow write: if request.auth.uid == userId;
        }
      }

      // --- SECRET CHAT SYSTEM ---
      match /secret_requests/{requestId} {
        // Users can read their own requests
        allow read: if request.auth.uid == resource.data.from || request.auth.uid == resource.data.to;
        // Users can create requests
        allow create: if request.auth != null && request.auth.uid == request.resource.data.from;
        // Cloud Functions update on accept (mirrorSecretContactOnAccept)
        allow update, delete: if false;
      }

      // --- NOTIFICATIONS ---
      match /notification_queue/{notifId} {
        // Users can create notifications
        allow create: if request.auth != null;
        // Cloud Functions manage these
        allow read, update: if false;
      }

      // Catch-all for any other artifact subcollections
      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }
  }
}
